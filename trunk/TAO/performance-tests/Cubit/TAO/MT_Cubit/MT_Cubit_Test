#! /bin/sh
# $Id$
#
# Spawns MT_Cubit server and client executables on a single host.

usage="usage: $0 [-n <iterations>] [-t] [-l] <# low priority threads>"
usage2="    [-t] uses /tmp, [-l] suppresses use of -ORBiioplite"

user=`whoami`
ior_file=/tmp/MT_Cubit-ior.${user}
iterations=1000
client_exec_prefix=time
iiop_lite=-ORBiioplite

if [ "$HOSTTYPE" = "lynxos" ]; then
  server_exec_prefix='prio 30'
  tmp='/tmp/'
else
  server_exec_prefix=
  tmp=
fi


########
######## Interpret command arguments.
########
while getopts ?ln:t arg; do
  case $arg in
      l   ) iiop_lite= ;;
      n   ) iterations=$OPTARG ;;
      t   ) tmp='/tmp/' ;;
      '?' ) echo $usage; echo $usage2; exit 0 ;;
  esac
done
shift `expr $OPTIND - 1`

if [ $# -ne 1 ]; then
  echo $usage; echo $usage2
  exit 1
fi
threads=`expr $1 + 1`


########
######## Enable signal handler.
########
trap 'kill -1 $server_pid; /bin/rm -f $ior_file' 0 1 2 15


########
######## Start server and save its pid.
########
$server_exec_prefix ./server -s -f $ior_file -t $threads $iiop_lite > \
  ${tmp}server.log 2>&1 &
server_pid=$!

while [ ! -f $ior_file ]; do
  sleep 2
done


########
######## Start client.
########
$client_exec_prefix ./client -s -f $ior_file -t $threads -n $iterations \
  $iiop_lite  > ${tmp}client-${threads}.log 2>&1
