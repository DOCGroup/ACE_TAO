#! /bin/sh
# $Id$
#
# Spawns MT_Cubit server and client executables on a single host.

usage="usage: $0 [-n <iterations>] [-t] <number of low priority threads>"

user=`whoami`
ior_file=/tmp/MT_Cubit-ior.${user}
iterations=1000
tmp=

if [ "$HOSTTYPE" = "lynxos" ]; then
  server_exec_prefix='prio 30'
  tmp='/tmp/'
else
  server_exec_prefix=
fi
client_exec_prefix=time


########
######## Interpret command arguments.
########
while getopts ?n:t arg; do
  case $arg in
      n   ) iterations=$OPTARG ;;
      t   ) tmp='/tmp/' ;;
      '?' ) echo $usage; exit 0 ;;
  esac
done
shift `expr $OPTIND - 1`

if [ $# -ne 1 ]; then
  echo $usage
  exit 1
fi
threads=`expr $1 + 1`


########
######## Enable signal handler.
########
trap 'kill -1 $server_pid; /bin/rm -f $ior_file' 0 1 2 15


########
######## Start server and save its pid.
########
$server_exec_prefix ./server -s -f $ior_file -t $threads > \
   ${tmp}server.log 2>&1 &
server_pid=$!

sleep 4


########
######## Start client.
########
./client -s -f $ior_file -t $threads -n $iterations > \
  ${tmp}client-${threads}.log 2>&1
