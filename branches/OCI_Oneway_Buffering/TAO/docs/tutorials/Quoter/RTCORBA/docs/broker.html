<!-- $Id$ -->

<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
  <title>Stock Broker implementation for the Stock Quoter Publisher/Subscriber Real-time CORBA Service</title>
</head>

<body
 text = "#000000"
 link = "#000fff"
 vLink= "#ff0f0f"
 aLink = "#0000ff"
 bgColor = "#ffffff">

<hr><h2>Stock Broker implementation for the Stock Quoter Publisher/Subscriber Real-time CORBA Service</h2><hr>

<h3>Implementation of StockBrokerHome interface</h3>

This interface is used to create StockBroker objects. <P>
The Stock_StockBrokerHome_i class is generated automatically by the IDL compiler (using the -GI flag),
which is a subclass of POA_Stock::StockBrokerHome class. <P>

<h4>Implementing the Constructor</h4>

The main steps of this function are described as follows: <P>

<li>Register the necessary factories and mappings with the specified orb.</li>

<PRE>
    Stock::StockName_init *stockname_factory = new Stock::StockName_init;
    orb->register_value_factory (stockname_factory->tao_repository_id (),
                                 stockname_factory
                                 ACE_ENV_ARG_PARAMETER);

    Stock::Cookie_init *cookie_factory = new Stock::Cookie_init;
    orb->register_value_factory (cookie_factory->tao_repository_id (),
                                 cookie_factory
                                 ACE_ENV_ARG_PARAMETER);

    Stock_PriorityMapping::register_mapping (orb);
</PRE>

<li>Create a new instance of the StockBroker object. And because the broker has nothing to do with the RTCORBA
mechanisms, we can activate it under the default POA. The "stock_name" and "priority" are in the arguments of
the Constructor.</li>

<PRE>
    broker_ = new Stock_StockBroker_i (orb, stock_name, priority);
    PortableServer::ServantBase_var broker_owner_transfer = broker_;
    _default_POA ()->activate_object (broker_);
</PRE>

<h4>Implementing the create () member function</h4>

Return the StockBroker object created by the Constructor.

<PRE>
    return Stock::StockBroker::_duplicate (broker_->_this ());
</PRE>

<hr><h3>Implementation of StockBroker interface</h3>

This interface is used for Stock Broker client. <P>
The Stock_StockBroker_i class is generated automatically by the IDL compiler (using the -GI flag),
which is a subclass of POA_Stock::StockBroker class. <P>

<h4>Implementing the Constructor</h4>

<PRE>
    Stock_StockBroker_i (CORBA::ORB_ptr orb, const char *stock_name, RTCORBA::Priority priority)
      : quoter_ (Stock::StockQuoter::_nil()), consumer_ (0)
</PRE>

The "quoter_" and "consumer_" are two private members of the Stock_StockBroker_i class. They stand 
for the StockQuoter object that is used to get detailed stock information and the StockNameConsumer 
object that is used to get notification of updates. <P>

The main steps of this function are described as follows: <P>

<li>Get a reference to the RTORB.</li>

<li>Initialize a CORBA::PolicyList object.</li>

<li>Create a SERVER_DECLARED priority model policy and add it into the former CORBA::PolicyList object.</li>

<li>Create a child POA using the former CORBA::PolicyList and narrow it to RTPOA.</li>

<li>Create a new instance of the StockNameConsumer object with the specified name and activate it 
under the former RTPOA with the specified priority.</li>

<PRE>
    CORBA::Object_var obj = orb->resolve_initial_references ("RTORB");
    RTCORBA::RTORB_var rt_orb = RTCORBA::RTORB::_narrow (obj.in ());
    
    CORBA::PolicyList consumer_policies (1);
    consumer_policies.length (1);

    consumer_policies[0] = rt_orb->create_priority_model_policy (RTCORBA::SERVER_DECLARED,
    Stock_PriorityMapping::MEDIUM);

    PortableServer::POA_var poa = this->_default_POA()->create_POA (
      "StockNameConsumer_POA", PortableServer::POAManager::_nil (), consumer_policies);
  
    RTPortableServer::POA_var rt_poa = RTPortableServer::POA::_narrow (poa);
    
    consumer_ = new Stock_StockNameConsumer_i (_this (), stock_name);
    PortableServer::ServantBase_var nameconsumer_owner_transfer = consumer_;
    rt_poa->activate_object_with_priority (consumer_, priority);
</PRE>

<h4>Implementing the get_consumer_notifier () member function</h4>

Return the StockNameConsumer object created by the Constructor.

<PRE>
    return Stock::StockNameConsumer::_duplicate (consumer_->_this ());
</PRE>

<h4>Implementing the connect_quoter_info () member function</h4>

Duplicate a StockQuoter object using the StockQuoter object reference "c" in the argument.

<PRE>
    quoter_ = Stock::StockQuoter::_duplicate (c);
</PRE>

<h4>Implementing the disconnect_quoter_info () member function</h4>

Destroy the StockQuoter object and return it.

<PRE>
  Stock::StockQuoter_var old_quoter = quoter_;
  quoter_ = Stock::StockQuoter::_nil();
  return old_quoter._retn ();
</PRE>

<h4>Implementing the get_connection_quoter_info () member function</h4>

Return the StockQuoter object.

<PRE>
  return Stock::StockQuoter::_duplicate (quoter_);
</PRE>

<hr><b>Email: </b><a href="mailto:"</a<ADDRESS>shanshan.jiang@vanderbilt.edu</ADDRESS>

</body>

</html>
