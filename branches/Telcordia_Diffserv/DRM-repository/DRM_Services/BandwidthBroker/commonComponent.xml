<?xml version="1.0" encoding="ISO-8859-1"?>
<!-- ==================================================================== -->
<!--                                                                      -->
<!-- OpenCCM: The Open CORBA Component Model Platform                     -->
<!-- Copyright (C) 2000-2003 INRIA - USTL - LIFL - GOAL                   -->
<!-- Contact: openccm@objectweb.org                                       -->
<!--                                                                      -->
<!-- This library is free software; you can redistribute it and/or        -->
<!-- modify it under the terms of the GNU Lesser General Public           -->
<!-- License as published by the Free Software Foundation; either         -->
<!-- version 2.1 of the License, or any later version.                    -->
<!--                                                                      -->
<!-- This library is distributed in the hope that it will be useful,      -->
<!-- but WITHOUT ANY WARRANTY; without even the implied warranty of       -->
<!-- MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the GNU     -->
<!-- Lesser General Public License for more details.                      -->
<!--                                                                      -->
<!-- You should have received a copy of the GNU Lesser General Public     -->
<!-- License along with this library; if not, write to the Free Software  -->
<!-- Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 -->
<!-- USA                                                                  -->
<!--                                                                      -->
<!-- Initial developer(s): Romain Rouvoy, Philippe Merle.                 -->
<!-- Contributor(s): Sylvain Leblanc, Christophe Demarey.                 -->
<!--                 Jerome Offroy, Mike Gratsas,                         -->
<!--                 Christophe Contreras.                                -->
<!--                                                                      -->
<!-- ==================================================================== -->

<!-- ==================================================================== -->
<!--                                                                      -->
<!--  Common part for the OpenCCM's demonstration builds.                 -->
<!--    It contains usual application build process including:            -->
<!--      -IDL3, IDL2, CIDL compilations using OpenCCM's production chain -->
<!--      -Java code compilation (stubs + skeletons + implementations)    -->
<!--                                                                      -->
<!--    It is highly recommended to use this file for your applications,  -->
<!--      including it as it's done from our demos                        -->
<!--      ( with of course any needed adaptation ;-) )                    -->
<!--        then a <antcall target="application_full"/>                   -->
<!--        will do the job right . DON'T FORGET THE                     -->
<!--          ../common/build.properties                                  -->
<!--                                                                      -->
<!-- ==================================================================== -->

<project name="OpenCCM_demo_build" default="build_app_archives">

  <!-- Will allow usage of local environment variables -->
  <property environment="user.environment"/>

  <!-- The common/build.properties uses the application's name for        -->
  <!--   determination of idl3, cidl, idl2, local and cif idl filenames.  -->
  <!-- It also define common resource names like src, generated, idl,     -->
  <!--   stubs, skeletons, classes directories, packages and JAR names.   -->
  <!-- Its path may be overridden, this is a default value for our demos. -->
  <property name="path.to.common.files" value="."/>
  <property file="${path.to.common.files}/commonComponentBuild.properties" />

  <import file="${openccm.dir}/ant/openccm.xml"/>

  <!-- ================================================================== -->
  <!--                                                                    -->
  <!-- Define the project class path.                                     -->
  <!--                                                                    -->
  <!-- ================================================================== -->

  <path id="project.class.path">

    <!-- This allows the specialization of the build CLASSPATH            -->
    <!--  the calling application's build can provide extra JARs          -->
    <!--  filling "demo.specific.classpath" BEFORE importing  this file   -->
    <path refid="demo.specific.classpath" />

    <path refid="orb.classpath" />
    <path refid="jre.classpath" />

    <!-- ================================================================ -->
    <!--                                                                  -->
    <!-- All the required OpenCCM JAR files.                              -->
    <!--                                                                  -->
    <!-- ================================================================ -->

    <!-- The OpenCCM runtime.                                             -->
    <pathelement path="${openccm.dir}/lib/OpenCCM_Runtime.jar" />

    <!-- The OpenCCM production platform.                                 -->
    <pathelement path="${openccm.dir}/lib/OpenCCM_Platform.jar" />

    <!-- The OpenCCM CORBA wrapper.                                       -->
    <pathelement path="${openccm.dir}/lib/CORBA.jar" />

    <!-- The OpenCCM plugins.                                             -->
    <pathelement path="${openccm.dir}/lib/OpenCCM_Plugins.jar" />


     <!-- Temporary required for classes:                                 -->
    <!-- * org.objectweb.corba.util.LocalObjectBase                       -->
    <!-- * ...                                                            -->
    <pathelement path="${openccm.dir}/lib/OpenCCM_Utils.jar" />

    <!-- Temporary required for classes:                                  -->
    <!-- * org.objectweb.openccm.Deployment.CCMHomeLocal              -->
    <!-- * ...                                                            -->
    <pathelement path="${openccm.dir}/lib/OpenCCM_Deployment.jar" />


    <!-- Adding the explorer archive                                      -->
    <pathelement path="${openccm.dir}/lib/ow_util_explorer.jar" />
    <!-- Adding the ccm explorer archive                                  -->
    <pathelement path="${openccm.dir}/lib/ow_ccm_explorer.jar" />

    <pathelement path="${openccm.dir}/lib/ow_openccm_production.jar" />
    <pathelement path="${openccm.dir}/lib/ots/jdbc2_0-stdext.jar" />
    <pathelement path="${openccm.dir}/lib/ots/jta_1.0.1.jar" />
    <pathelement path="${openccm.dir}/lib/ots/openorb_ots-1.3.0.jar" />
  </path>

  <!-- ================================================================== -->
  <!-- The main steps.                                                    -->
  <!-- ================================================================== -->
  <target name="build_app_archives" depends="application_step4"/>

  <target name="application_step0" depends="-antcontrib.init">
    <echo message=" * Step 0: Clean" />
    <antcall target="application_clean" />
  </target>
  <target name="application_step1" depends="application_step0">
    <echo message="" />
    <echo message=" * Step 1: Initialisation" />
    <antcall target="application_create_directories" />
    <antcall target="monolog_setup" />
  </target>
  <target name="application_step2" depends="application_step1,openccm_tasks">
    <echo message="" />
    <echo message=" * Step 2: Generation" />
    <antcall target="application_generation" />
    <antcall target="application_generate_stubs" />
  </target>

  <target name="application_step2a" depends="-antcontrib.init" unless="user.environment.IDL_BYPASS">
    <echo message="Step 2a" />
    <antcall target="application_step2"/>
  </target>

  <target name="application_step3" depends="application_step2a">
    <echo message="" />
    <echo message=" * Step 3: Compilation" />
<!--    <antcall target="application_compile_cosproperty" />  -->
    <antcall target="application_compile_stubs" />
    <antcall target="application_compile_poas" />
    <antcall target="application_compile_skeletons" />
    <antcall target="application_compile_stubs_n_skeletons" />
    <antcall target="application_compile_implementations" />
  </target>
  <target name="application_step4" depends="application_step3">
    <echo message="" />
    <echo message=" * Step 4: Archiving ( FINAL STEP )" />
  </target>

  <!-- ================================================================== -->
  <!-- Clean up old and generated files.                                  -->
  <!-- ================================================================== -->

  <target name="application_reset" depends="application_clean">
    <delete failonerror="false">
      <fileset dir="${application.root.dir}">
        <exclude name="build.xml"/>
        <include name="build.*"/>
        <include name="bin/cp.bat"/>
        <include name="demo.xml" />
        <include name="*log*"/>
      </fileset>
    </delete>
  </target>

  <target name="application_clean">
    <echo message="  ==> Cleaning application &lt;${application.name}&gt;" />
    <delete dir="${application.archives.dir}" includeEmptyDirs="true" failonerror="false" />
    <delete dir="${application.gen.dir}" includeEmptyDirs="true" failonerror="false" />
  </target>

  <!-- ================================================================== -->
  <!-- Create directories.                                                -->
  <!-- ================================================================== -->

  <target name="application_create_directories">
    <echo message="  ==> Creating target and archives directories" />
    <mkdir dir="${application.gen.dir}" />
    <mkdir dir="${application.gen.idl.dir}" />
    <mkdir dir="${application.gen.stubs.dir}" />
    <mkdir dir="${application.gen.skel.dir}" />
    <mkdir dir="${application.gen.idl2java.dir}" />
    <mkdir dir="${application.gen.cosp.dir}" />
    <mkdir dir="${application.class.dir}" />
    <mkdir dir="${application.dependencies.dir}" />
    <mkdir dir="${application.archives.dir}" />
    <mkdir dir="${ecm.servant.application.class.dir}"/>
  </target>

  <!-- ================================================================== -->
  <!-- Generate the OMG IDL2 file and OpenCCM skeletons.                  -->
  <!-- ================================================================== -->

  <target name="application_generation">
 
    <openccm>
      <ir3_feed>
<!--        <file name="${openccm.dir}/idl/CosNaming.idl"/>
        <file name="${openccm.dir}/idl/CosTrading.idl"/>
-->
        <file name="${application.idl.dir}/${application.idl3.name}"/>

        <cpp>
          <includepath name="${openccm.dir}/idl"/>
          <includepath name="${application.arms.include.dir}"/>
          <includepath name="${application.idl2include.dir}"/>
          <includepath name="${application.idl.dir}"/>
        </cpp>

      </ir3_feed>

      <ir3_idl2 scope="::mil::darpa::arms::mlrm"
                destfile="${application.gen.idl.dir}/${application.idl2.name}">
<!--            <include name="CORBA.idl" />   -->
            <include name="TypeCode.idl" />
            <include name="CosPropertyService.idl" />
<!--
            <include name="CosNaming.idl" />
        <include name="CosTrading.idl" />
-->
      </ir3_idl2>

      <ir3_java scope="::mil::darpa::arms::mlrm"
                destdir="${application.gen.skel.dir}" />

      <cidl_cif file="${application.idl.dir}/${application.cidl.name}"
                destfile="${application.gen.idl.dir}/${application.idl2.cif.name}"
                destdir="${application.gen.skel.dir}"
                dependenciesdir="${application.dependencies.dir}">
        <userinclude name="${application.idl2.local.name}"/>
      </cidl_cif>
   </openccm>
  </target>

  <target name="ecm_generation"  if="ecm.install.dir">
  	<echo message="   * Generating ECM servant " />
	  <echo message="execute ${ecm.install.dir}/bin/ir3_servant.bat ${application.gen.ecm.servant.dir}"/>
	  <exec executable="${ecm.install.dir}/bin/ir3_servant.bat">
	    <arg line =" --outputdir ${application.gen.ecm.servant.dir} ${application.name} "/>
	  </exec>	
	  
	  <echo message=" * Generation ECM container interceptor"/>
	  <exec executable="${ecm.install.dir}/bin/ir3_copi.bat">
	    <arg line =" -d ${application.gen.ecm.servant.dir} ${application.name} "/>
	  </exec>	
  </target>

  <!-- ================================================================== -->
  <!-- Generate Java CORBA 2 stubs.                                       -->
  <!-- ================================================================== -->
  <target name="application_generate_stubs">
    <echo message="  ==> Generating ${application.name} CORBA 2 stubs" />
    <!-- Remote interfaces -->
    <echo message="Remote interfaces"/>
    <idl2java file="${application.gen.idl.dir}/${application.idl2.name}"
              destdir="${application.gen.stubs.dir}"
              includes="${application.gen.idl.dir},${openccm.dir}/idl,${application.arms.include.dir},${application.idl.dir},${application.idl2include.dir},${jacorb.idl.dir}">
      <mapping idlpkg="${application.name}" javapkg="${application.idl2java.package}"/>
    </idl2java>
    <!-- Local interfaces -->
    <echo message="Local interfaces"/>
    <idl2java file="${application.gen.idl.dir}/${application.idl2.local.name}"
              destdir="${application.gen.stubs.dir}"
              includes="${application.gen.idl.dir},${openccm.dir}/idl,${application.arms.include.dir},${application.idl.dir},${application.idl2include.dir},${jacorb.idl.dir}">
      <mapping idlpkg="${application.name}" javapkg="${application.idl2java.package}"/>
    </idl2java>
    <!-- CIF interfaces -->
    <echo message="CIF interfaces"/>
    <idl2java file="${application.gen.idl.dir}/${application.idl2.cif.name}"
              destdir="${application.gen.stubs.dir}"
              includes="${application.gen.idl.dir},${openccm.dir}/idl,${application.arms.include.dir},${application.idl.dir},${application.idl2include.dir},${jacorb.idl.dir}">
      <mapping idlpkg="${application.name}" javapkg="${application.idl2java.package}"/>
    </idl2java>
    <!-- the build for other IDL files not in the component includes -->
    <echo message="Other IDL files"/>
    <idl2java file="${application.idl.dir}/ProbeControl.idl"
              destdir="${application.gen.idl2java.dir}"
              includes="${application.gen.idl.dir},${openccm.dir}/idl,${application.arms.include.dir},${jacorb.idl.dir}">
      <mapping idlpkg="${application.name}" javapkg="${application.idl2java.package}"/>
    </idl2java>
    <echo message="More Other IDL files"/>
    <idl2java file="${application.idl.dir}/TrafficClassQOSProvisioning.idl"
              destdir="${application.gen.idl2java.dir}"
              includes="${application.gen.idl.dir},${openccm.dir}/idl,${application.arms.include.dir},${jacorb.idl.dir}">
      <mapping idlpkg="${application.name}" javapkg="${application.idl2java.package}"/>
    </idl2java>
    <idl2java file="${application.idl.dir}/FaultMonitorClient.idl"
              destdir="${application.gen.idl2java.dir}"
              includes="${application.gen.idl.dir},${openccm.dir}/idl,${application.arms.include.dir},${jacorb.idl.dir}">
      <mapping idlpkg="${application.name}" javapkg="${application.idl2java.package}"/>
    </idl2java>
    <idl2java file="${application.idl.dir}/NMClient.idl"
              destdir="${application.gen.idl2java.dir}"
              includes="${application.gen.idl.dir},${openccm.dir}/idl,${application.arms.include.dir},${jacorb.idl.dir}">
      <mapping idlpkg="${application.name}" javapkg="${application.idl2java.package}"/>
    </idl2java>
    <!-- the build for the CosProperty IDL files not provided by JacORB -->
<!--
    <idl2java file="${arms.idl.dir}/CosPropertyTemp.idl"
              destdir="${application.gen.cosp.dir}"
              includes="${application.gen.idl.dir},${openccm.dir}/idl,${application.arms.include.dir},${jacorb.idl.dir}">
      <mapping idlpkg="${application.name}" javapkg="${omg.idl2java.package}"/>
    </idl2java>
-->
  </target>



  <!-- ================================================================== -->
  <!-- Compile generated Java CosProperty stubs and skeletons.          -->
  <!-- ================================================================== -->
<!--
  <target name="application_compile_cosproperty">
    <echo message="  ==> Compiling CosProperty for Java." />
    <antcall target="openccm.javac">
      <param name="srcdir" value="${application.gen.cosp.dir}" />
      <param name="destdir" value="${application.class.dir}" />
      <param name="files" value="${application.cos.dir}/*.java" />
      <param name="files" value="${application.omg.dir}/**/*.java" />
    </antcall>
  </target>

-->

  <!-- ================================================================== -->
  <!-- Compile generated Java CORBA 2 stubs.                              -->
  <!-- ================================================================== -->

  <target name="application_compile_stubs">
    <echo message="  ==> Compiling generated Java CORBA 2 stubs." />
    <antcall target="openccm.javac">
      <param name="srcdir" value="${application.gen.stubs.dir}" />
      <param name="destdir" value="${application.class.dir}" />
      <param name="files" value="${application.pkg.dir}/**/*.java" />
    </antcall>
  </target>

  <!-- ================================================================== -->
  <!-- Compile generated Java CORBA 2 POAS .                              -->
  <!-- ================================================================== -->

  <target name="application_compile_poas">
    <echo message="  ==> Compiling generated Java POA classes." />
    <antcall target="openccm.javac">
      <param name="srcdir" value="${application.gen.stubs.dir}" />
      <param name="destdir" value="${application.class.dir}" />
      <param name="files" value="${application.mlrm.dir}/ConditionConsumerPOA.java" />
    </antcall>
  </target>

  <!-- ================================================================== -->
  <!-- Compile generated Java OpenCCM skeletons.                          -->
  <!-- ================================================================== -->

  <target name="application_compile_skeletons">
    <echo message="  ==> Compiling generated Java OpenCCM skeletons." />
    <antcall target="openccm.javac">
      <param name="srcdir" value="${application.gen.skel.dir}" />
      <param name="destdir" value="${application.class.dir}" />
      <param name="files" value="${application.pkg.dir}/**/*.java" />
    </antcall>
  </target>

  <!-- ================================================================== -->
  <!-- Compile generated Java non-component stubs and skeletons.          -->
  <!-- ================================================================== -->

  <target name="application_compile_stubs_n_skeletons">
    <echo message="  ==> Compiling generated Java non-component stubs and skeletons." />
    <antcall target="openccm.javac">
      <param name="srcdir" value="${application.gen.idl2java.dir}" />
      <param name="destdir" value="${application.class.dir}" />
      <param name="files" value="${application.pkg.dir}/**/*.java" />
    </antcall>
  </target>


  <!-- ================================================================== -->
  <!-- Compile all Java implementation sources.                           -->
  <!-- ================================================================== -->

  <target name="application_compile_implementations">
    <echo message="  ==> Compiling all Java implementation sources." />
    <antcall target="openccm.javac">
      <param name="srcdir" value="${application.src.dir}" />
      <param name="destdir" value="${application.class.dir}" />
      <param name="files" value="**/*.java" />
      <param name="excludeFiles" value="**/topologyDB/**" />
    </antcall>
  </target>


  <!-- ================================================================== -->
  <!--                                                                    -->
  <!-- Javac with OpenCCM bootclass and class paths set.                  -->
  <!--                                                                    -->
  <!-- Parameters are:                                                    -->
  <!-- * srcdir  The directory containing Java source files.              -->
  <!-- * destdir The directory containing Java class files.               -->
  <!-- * files   The files to compile.                                    -->
  <!--                                                                    -->
  <!-- ================================================================== -->

  <target name="openccm.javac">
    <javac failonerror="true"
           srcdir="${srcdir}"
           destdir="${destdir}"
           debug="on">
      <classpath refid="project.class.path" />
<!--      <bootclasspath refid="project.boot.class.path" />-->
      <include name="${files}" />
      <exclude name="${excludeFiles}" />
    </javac>
  </target>


  <!-- ================================================================== -->
  <!--                                                                    -->
  <!-- Target name: monolog_setup                                         -->
  <!--                                                                    -->
  <!-- Description: writes Monolog's config file to point an output dir   -->
  <!--                                                                    -->
  <!-- Parameters:                                                        -->
  <!--                                                                    -->
  <!--   Name             Description                                     -->
  <!--                                                                    -->
  <!-- Use example:                                                       -->
  <!--                                                                    -->
  <!--   <antcall target="monolog_setup" />                               -->
  <!--                                                                    -->
  <!-- ================================================================== -->

  <target name="monolog_setup">
    <path id="monolog.output.dir">
        <pathelement location="${ccmlog.dir}/" />
    </path>
    <pathconvert targetos="unix" property="monolog.output.dir.unix" refid="monolog.output.dir"/>

    <echo message="  ==> Copying Monolog property files" />
    <copy todir="${application.root.dir}" overwrite="true">
      <fileset dir="${openccm.dir}/ant" includes="monolog.CCM.properties"/>
      <filterset>
        <filter token="MONOLOG_DEFAULT_OUTPUT_DIR" value="${monolog.output.dir.unix}/" />
      </filterset>
    </copy>
  </target>

</project>
